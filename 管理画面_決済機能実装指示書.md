# 管理画面 決済機能実装指示書

## プロジェクト概要

**技術スタック:**

- バックエンド: Laravel 10.x (PHP 8.4)
- フロントエンド: Nuxt.js 3.x + TypeScript
- 決済: Stripe API (テストモード対応)
- データベース: MySQL 8.0
- UI: Laravel Blade + TailwindCSS + Alpine.js

**現在の状況:**

- Stripe 決済機能は実装済み（StripeService、決済 API、Webhook 処理）
- 管理画面の基本構造は完成済み
- 既存モデル: User, Subscription, SubscriptionHistory

## 実装対象機能

### 1. 決済ダッシュボード (`/admin/billing`)

### 2. サブスクリプション管理 (`/admin/billing/subscriptions`)

### 3. 決済履歴管理 (`/admin/billing/payments`)

### 4. Webhook イベントログ (`/admin/billing/webhooks`)

### 5. 分析・レポート (`/admin/billing/analytics`)

---

## 段階的実装計画

### Phase 1: データベース設計・マイグレーション

#### 1.1 WebhookLog テーブル作成

```bash
php artisan make:migration create_webhook_logs_table
```

**マイグレーション内容:**

```php
// database/migrations/YYYY_MM_DD_create_webhook_logs_table.php
public function up()
{
    Schema::create('webhook_logs', function (Blueprint $table) {
        $table->id();
        $table->string('stripe_event_id')->unique();
        $table->string('event_type');
        $table->json('payload');
        $table->enum('status', ['pending', 'processed', 'failed'])->default('pending');
        $table->text('error_message')->nullable();
        $table->timestamp('processed_at')->nullable();
        $table->timestamps();

        $table->index(['event_type', 'status']);
        $table->index('created_at');
    });
}
```

#### 1.2 PaymentTransaction テーブル作成

```bash
php artisan make:migration create_payment_transactions_table
```

**マイグレーション内容:**

```php
// database/migrations/YYYY_MM_DD_create_payment_transactions_table.php
public function up()
{
    Schema::create('payment_transactions', function (Blueprint $table) {
        $table->id();
        $table->foreignId('user_id')->constrained()->onDelete('cascade');
        $table->foreignId('subscription_id')->nullable()->constrained()->onDelete('set null');
        $table->string('stripe_payment_intent_id')->unique();
        $table->string('stripe_charge_id')->nullable();
        $table->decimal('amount', 10, 2);
        $table->string('currency', 3)->default('jpy');
        $table->enum('status', ['pending', 'succeeded', 'failed', 'canceled', 'refunded'])->default('pending');
        $table->enum('type', ['subscription', 'one_time'])->default('subscription');
        $table->decimal('refund_amount', 10, 2)->default(0);
        $table->json('metadata')->nullable();
        $table->timestamp('paid_at')->nullable();
        $table->timestamps();

        $table->index(['user_id', 'status']);
        $table->index(['status', 'type']);
        $table->index('created_at');
    });
}
```

#### 1.3 モデル作成

**WebhookLog モデル:**

```php
// app/Models/WebhookLog.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Carbon\Carbon;

class WebhookLog extends Model
{
    protected $fillable = [
        'stripe_event_id',
        'event_type',
        'payload',
        'status',
        'error_message',
        'processed_at',
    ];

    protected $casts = [
        'payload' => 'array',
        'processed_at' => 'datetime',
    ];

    public function scopeProcessed($query)
    {
        return $query->where('status', 'processed');
    }

    public function scopeFailed($query)
    {
        return $query->where('status', 'failed');
    }

    public function scopeRecent($query, $days = 7)
    {
        return $query->where('created_at', '>=', Carbon::now()->subDays($days));
    }

    public function getFormattedPayloadAttribute()
    {
        return json_encode($this->payload, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    }
}
```

**PaymentTransaction モデル:**

```php
// app/Models/PaymentTransaction.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PaymentTransaction extends Model
{
    protected $fillable = [
        'user_id',
        'subscription_id',
        'stripe_payment_intent_id',
        'stripe_charge_id',
        'amount',
        'currency',
        'status',
        'type',
        'refund_amount',
        'metadata',
        'paid_at',
    ];

    protected $casts = [
        'amount' => 'decimal:2',
        'refund_amount' => 'decimal:2',
        'metadata' => 'array',
        'paid_at' => 'datetime',
    ];

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function subscription()
    {
        return $this->belongsTo(Subscription::class);
    }

    public function scopeSucceeded($query)
    {
        return $query->where('status', 'succeeded');
    }

    public function scopeThisMonth($query)
    {
        return $query->whereYear('created_at', now()->year)
                     ->whereMonth('created_at', now()->month);
    }

    public function getFormattedAmountAttribute()
    {
        return number_format($this->amount) . ' ' . strtoupper($this->currency);
    }

    public function getNetAmountAttribute()
    {
        return $this->amount - $this->refund_amount;
    }
}
```

#### 1.4 既存モデルの拡張

**Subscription モデルにリレーション追加:**

```php
// app/Models/Subscription.php
public function paymentTransactions()
{
    return $this->hasMany(PaymentTransaction::class);
}
```

---

### Phase 2: コントローラー・サービス実装

#### 2.1 BillingController 作成

```bash
php artisan make:controller Admin/BillingController
```

**主要メソッド:**

- `dashboard()` - 決済ダッシュボード
- `index()` - サブスクリプション一覧
- `show($id)` - サブスクリプション詳細
- `payments()` - 決済履歴一覧
- `webhooks()` - Webhook ログ一覧
- `analytics()` - 分析・レポート

#### 2.2 StripeService 拡張

**追加メソッド:**

```php
// app/Services/StripeService.php

public function cancelSubscription($subscriptionId)
{
    return $this->stripe->subscriptions->cancel($subscriptionId);
}

public function resumeSubscription($subscriptionId)
{
    return $this->stripe->subscriptions->resume($subscriptionId);
}

public function refundPayment($chargeId, $amount = null)
{
    $params = ['charge' => $chargeId];
    if ($amount) {
        $params['amount'] = $amount;
    }
    return $this->stripe->refunds->create($params);
}
```

#### 2.3 ルーティング設定

```php
// routes/web.php
Route::prefix('admin')->middleware(['auth:admin'])->name('admin.')->group(function () {
    Route::prefix('billing')->name('billing.')->group(function () {
        Route::get('/', [BillingController::class, 'dashboard'])->name('dashboard');
        Route::get('subscriptions', [BillingController::class, 'index'])->name('subscriptions.index');
        Route::get('subscriptions/{id}', [BillingController::class, 'show'])->name('subscriptions.show');
        Route::post('subscriptions/{id}/cancel', [BillingController::class, 'cancelSubscription'])->name('subscriptions.cancel');
        Route::post('subscriptions/{id}/resume', [BillingController::class, 'resumeSubscription'])->name('subscriptions.resume');

        Route::get('payments', [BillingController::class, 'payments'])->name('payments.index');
        Route::get('payments/{id}', [BillingController::class, 'showPayment'])->name('payments.show');
        Route::post('payments/{id}/refund', [BillingController::class, 'refundPayment'])->name('payments.refund');

        Route::get('webhooks', [BillingController::class, 'webhooks'])->name('webhooks.index');
        Route::get('webhooks/{id}', [BillingController::class, 'showWebhook'])->name('webhooks.show');

        Route::get('analytics', [BillingController::class, 'analytics'])->name('analytics.index');
        Route::get('analytics/export', [BillingController::class, 'exportAnalytics'])->name('analytics.export');
    });
});
```

---

### Phase 3: ビュー・UI 実装

#### 3.1 決済ダッシュボード

**ファイル:** `resources/views/admin/billing/dashboard.blade.php`

**表示内容:**

- 月間売上統計
- アクティブサブスクリプション数
- 新規契約・解約数
- プラン別契約数（円グラフ）
- 月別売上推移（線グラフ）
- 最近の Webhook エラー

#### 3.2 サブスクリプション管理

**ファイル:** `resources/views/admin/billing/subscriptions/`

- `index.blade.php` - 一覧表示
- `show.blade.php` - 詳細表示

**機能:**

- フィルタリング（ステータス、プラン、検索）
- ページネーション
- サブスクリプション詳細情報
- Stripe 情報との同期表示
- キャンセル・再開ボタン

#### 3.3 決済履歴管理

**ファイル:** `resources/views/admin/billing/payments/`

- `index.blade.php` - 決済履歴一覧
- `show.blade.php` - 決済詳細

**機能:**

- 決済ステータス別フィルタ
- 日付範囲検索
- 返金処理機能
- CSV エクスポート

#### 3.4 Webhook ログ

**ファイル:** `resources/views/admin/billing/webhooks/`

- `index.blade.php` - Webhook ログ一覧
- `show.blade.php` - Webhook 詳細

**機能:**

- イベントタイプ別フィルタ
- ステータス別表示
- ペイロード詳細表示
- エラー情報表示

#### 3.5 分析・レポート

**ファイル:** `resources/views/admin/billing/analytics/index.blade.php`

**機能:**

- MRR（Monthly Recurring Revenue）計算
- チャーン率分析
- 期間別売上分析
- データエクスポート機能

#### 3.6 サイドバーメニュー追加

**ファイル:** `resources/views/admin/layouts/app.blade.php`

```html
<a
  href="{{ route('admin.billing.dashboard') }}"
  class="nav-link {{ request()->routeIs('admin.billing*') ? 'active' : '' }}"
>
  <i class="fas fa-credit-card me-2"></i> 決済管理
</a>
```

---

## Webhook 処理の強化

### 既存 Webhook 処理にログ機能追加

```php
// app/Services/StripeService.php のhandleWebhook()メソッドを拡張

public function handleWebhook($payload, $signature)
{
    $event = null;

    // Webhookログの作成
    $webhookLog = WebhookLog::create([
        'stripe_event_id' => $payload['id'] ?? 'unknown',
        'event_type' => $payload['type'] ?? 'unknown',
        'payload' => $payload,
        'status' => 'pending'
    ]);

    try {
        $event = \Stripe\Webhook::constructEvent($payload, $signature, config('services.stripe.webhook_secret'));

        // 既存の処理...

        // 成功時のログ更新
        $webhookLog->update([
            'status' => 'processed',
            'processed_at' => now()
        ]);

    } catch (\Stripe\Exception\SignatureVerificationException $e) {
        $webhookLog->update([
            'status' => 'failed',
            'error_message' => 'Invalid signature: ' . $e->getMessage()
        ]);
        throw $e;
    } catch (\Exception $e) {
        $webhookLog->update([
            'status' => 'failed',
            'error_message' => $e->getMessage()
        ]);
        throw $e;
    }
}
```

### 決済トランザクションの自動記録

```php
// checkout.session.completed イベント処理時にPaymentTransactionを作成

private function handleCheckoutCompleted($session)
{
    // 既存の処理...

    // 決済トランザクションの記録
    PaymentTransaction::create([
        'user_id' => $user->id,
        'subscription_id' => $subscription->id,
        'stripe_payment_intent_id' => $session->payment_intent,
        'stripe_charge_id' => $session->charges->data[0]->id ?? null,
        'amount' => $session->amount_total / 100, // Stripeは cents単位
        'currency' => $session->currency,
        'status' => 'succeeded',
        'type' => 'subscription',
        'paid_at' => now(),
        'metadata' => [
            'session_id' => $session->id,
            'customer_email' => $session->customer_email
        ]
    ]);
}
```

---

## 実装時の注意事項

### 1. セキュリティ

- 管理者権限の適切なチェック
- CSRF 保護の確認
- 決済情報の適切なマスキング

### 2. パフォーマンス

- 大量データのページネーション
- 適切なインデックスの設定
- N+1 クエリの回避

### 3. エラーハンドリング

- Stripe API 呼び出し時の例外処理
- ネットワークエラーの適切な処理
- ユーザーフレンドリーなエラーメッセージ

### 4. ログ管理

- 重要な操作のログ記録
- 個人情報のログ除外
- ログローテーションの設定

### 5. テスト

- 各機能の単体テスト
- Stripe Webhook のテスト
- 管理画面のブラウザテスト

---BugBot

## 実装順序の推奨

1. **Phase 1**: データベース・モデル（即座に実装可能）
2. **Phase 2**: コントローラー・API（Phase 1 完了後）
3. **Phase 3**: ビュー・UI（Phase 2 完了後）

各 Phase ごとに動作確認を行い、問題がないことを確認してから次の Phase に進むことを強く推奨します。

---

## 完成時の機能一覧

✅ **決済ダッシュボード**

- 売上統計表示
- グラフによる可視化
- エラー監視

✅ **サブスクリプション管理**

- 全サブスクリプションの管理
- キャンセル・再開機能
- Stripe 連携

✅ **決済履歴管理**

- 全決済の追跡
- 返金処理
- エクスポート機能

✅ **Webhook 監視**

- リアルタイム処理状況
- エラー詳細確認
- 再処理機能

✅ **分析・レポート**

- MRR 計算
- チャーン率分析
- データエクスポート

この実装により、Stripe 決済の完全な管理機能を管理画面で提供できます。
