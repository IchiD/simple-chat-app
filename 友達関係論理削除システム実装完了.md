# 友達関係論理削除システム実装完了

## 概要
削除・バンされたユーザーが他のユーザーの友達一覧に残り続ける問題を解決し、アカウント復活時に元の友達関係も自動復活するシステムを実装しました。

## 実装した機能

### 1. データベース構造の拡張
- **新しいマイグレーション**: `2025_01_23_000000_add_soft_delete_to_friendships_table.php`
  - `deleted_at`: 友達関係の削除日時（論理削除）
  - `deleted_reason`: 削除理由
  - `deleted_by`: 削除を実行した管理者ID（外部キー）

### 2. Friendshipモデルの強化
- **SoftDeletes trait**の追加：論理削除機能の実装
- **新しいメソッド**：
  - `getFriendshipWithTrashed()`: 削除された友達関係も含めて取得
  - `deleteByAdmin()`: 管理者による友達関係の論理削除
  - `restoreByAdmin()`: 友達関係の復活
  - `isDeleted()`: 削除状態の確認
- **リレーション追加**: `deletedByAdmin()` - 削除した管理者との関係

### 3. Userモデルの友達関係メソッド修正
- **friends()**: 削除・バンされたユーザーを除外
- **pendingFriendRequests()**: 削除・バンされたユーザーからの申請を除外  
- **friendRequests()**: 削除・バンされたユーザーへの申請を除外
- **unfriend()**: 物理削除から論理削除に変更
- **deleteByAdmin()**: ユーザー削除時に友達関係も自動削除
- **restoreByAdmin()**: ユーザー復活時に友達関係も自動復活

### 4. 友達関係の自動管理
- **ユーザー削除時**:
  - 該当ユーザーの全友達関係を論理削除
  - 削除理由に「ユーザー（名前）の削除に伴う友達関係の削除」を記録
- **ユーザー復活時**:
  - パターンマッチングで該当する友達関係を自動復活
  - 削除理由に基づいて復活対象を特定

### 5. FriendshipControllerの更新
- **searchByFriendId()**: 削除・バンされたユーザーを検索結果から除外
- **sendRequest()**: 削除・バンされたユーザーへの申請を防止
- **既存機能の保護**: 削除・バンされたユーザーとの友達申請・承認を防止

### 6. 管理画面機能の追加
- **友達関係一覧画面**: `/admin/friendships`
  - ステータスフィルタ（アクティブ・削除済み・申請中・承認済み・拒否）
  - ユーザー名・メール・フレンドIDでの検索
  - ページネーション対応
- **友達関係詳細画面**: `/admin/friendships/{id}`
  - 友達関係の詳細情報表示
  - 削除・復活ボタン
- **管理機能**:
  - 友達関係の論理削除（理由付き）
  - 友達関係の復活
  - 削除履歴の表示

### 7. ルート追加
```php
// Friendship Management Routes
Route::get('friendships', [AdminDashboardController::class, 'friendships'])->name('friendships');
Route::get('friendships/{id}', [AdminDashboardController::class, 'showFriendship'])->name('friendships.show');
Route::delete('friendships/{id}', [AdminDashboardController::class, 'deleteFriendship'])->name('friendships.delete');
Route::post('friendships/{id}/restore', [AdminDashboardController::class, 'restoreFriendship'])->name('friendships.restore');
```

## システムの動作フロー

### ユーザー削除時
1. 管理者がユーザーを削除
2. ユーザーの論理削除実行
3. **自動実行**: 該当ユーザーの全友達関係を論理削除
4. 他のユーザーの友達一覧から該当ユーザーが除外される

### ユーザー復活時  
1. 管理者がユーザー削除を取り消し
2. ユーザーの復活実行
3. **自動実行**: ユーザー削除に伴って削除された友達関係を復活
4. 元の友達関係が完全に復元される

### 友達一覧表示時
- 削除・バンされたユーザーは一覧から除外
- 論理削除された友達関係も除外
- アクティブな友達のみ表示

## セキュリティと整合性

### データ整合性の保護
- 削除・バンされたユーザーとの新しい友達申請を防止
- 削除・バンされたユーザーの検索を防止
- 論理削除により履歴の保持

### 管理者による制御
- 個別友達関係の削除・復活が可能
- 削除理由の記録による監査証跡
- 管理画面での一元的な友達関係管理

## 利点

1. **データの永続性**: 物理削除ではなく論理削除により、データの復旧が可能
2. **自動復活**: ユーザー復活時に手動で友達関係を再構築する必要がない
3. **一貫性**: 削除・バンされたユーザーが友達一覧に表示されない
4. **監査証跡**: いつ・誰が・なぜ削除したかの記録
5. **管理の容易さ**: 管理画面から友達関係を一元管理

## 技術的特徴

- **Laravel SoftDeletes trait**活用による標準的な実装
- **リレーション活用**による効率的なデータ取得
- **パターンマッチング**による自動復活の実現
- **制約ベース**の整合性保護

この実装により、友達関係の管理が大幅に改善され、ユーザー体験と管理者の作業効率が向上しました。