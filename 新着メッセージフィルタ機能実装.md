# 新着メッセージフィルタ機能実装

## 概要
管理画面のサポートチャット一覧（`http://localhost/admin/support`）に、新着メッセージのあるチャットのみをフィルタリングする機能を追加しました。

## 実装内容

### 1. コントローラの修正 (`backend/app/Http/Controllers/Admin/AdminDashboardController.php`)

#### `supportConversations` メソッドの更新
- **新着メッセージフィルタ**: `filter=unread` パラメータが指定された場合、過去7日以内にユーザーからの新着メッセージがあるチャットのみを表示
- **未読メッセージ数の計算**: 各チャットについて過去7日以内のユーザーメッセージ数を計算し、`unread_count` として表示

#### フィルタ条件
```php
// 新着メッセージフィルタ
if ($request->get('filter') === 'unread') {
  $query->whereHas('messages', function ($messageQuery) {
    $messageQuery->where('sender_id', '!=', null) // ユーザーからのメッセージ
      ->whereNull('deleted_at')
      ->whereNull('admin_deleted_at')
      ->where('sent_at', '>=', now()->subDays(7)); // 過去7日以内の新着メッセージ
  });
}
```

### 2. ビューの修正 (`backend/resources/views/admin/support/index.blade.php`)

#### 追加された機能
1. **フィルタ選択ドロップダウン**: 検索フォームにフィルタオプションを追加
   - 「すべてのチャット」
   - 「新着メッセージのあるチャットのみ」

2. **クイックフィルタボタン**: ページ上部に新着メッセージのみ表示/すべて表示の切り替えボタン

3. **視覚的インジケータ**:
   - 新着メッセージがあるチャット行をハイライト表示（`table-warning` クラス）
   - 未読メッセージ数を「○件の新着」として表示
   - ヘッダーに総新着メッセージ数を表示

4. **フィルタ状態の表示**: 
   - フィルタ適用時にヘッダーに「新着メッセージのみ表示」バッジを表示
   - 空の状態でもフィルタに応じたメッセージを表示

## 使用方法

### 1. 新着メッセージのフィルタリング
- ページ上部の「新着のみ表示」ボタンをクリック
- または検索フォームのフィルタドロップダウンから「新着メッセージのあるチャットのみ」を選択

### 2. すべてのチャットの表示
- 「すべて表示」ボタンをクリック
- または「クリア」ボタンでフィルタをリセット

## 技術的詳細

### 新着メッセージの定義
- **対象**: ユーザーからのメッセージ（`sender_id` が null でない）
- **期間**: 過去7日以内（`sent_at >= now()->subDays(7)`）
- **除外**: 削除されたメッセージ（`deleted_at` または `admin_deleted_at` が null でない）

### 管理者読み取り状況について
現在のシステムでは管理者の読み取り状況を追跡するテーブル（`admin_conversation_reads`）が削除されているため、時間ベース（過去7日以内）でのフィルタリングを実装しています。

### パフォーマンス考慮
- フィルタリングはデータベースレベルで実行され、効率的な検索を実現
- ページネーションと組み合わせて大量のデータにも対応

## URL例
- すべてのチャット: `http://localhost/admin/support`
- 新着メッセージのみ: `http://localhost/admin/support?filter=unread`
- 検索と組み合わせ: `http://localhost/admin/support?search=ユーザー名&filter=unread`

## 今後の改善案
1. 管理者の読み取り状況追跡システムの復活
2. フィルタ期間の設定可能化（7日、30日、カスタム期間）
3. リアルタイム更新機能
4. 新着メッセージの通知機能