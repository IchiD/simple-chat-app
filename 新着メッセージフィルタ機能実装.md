# 管理者既読システム復活・未読メッセージフィルタ機能実装

## 概要
管理画面のサポートチャット一覧（`http://localhost/admin/support`）に、真の既読状態に基づく未読メッセージフィルタリング機能を実装しました。過去の既読システムを現在のアーキテクチャに適合させて復活させています。

## 実装内容

### 1. データベース構造の復活

#### 新テーブル: `admin_chat_reads`
```sql
CREATE TABLE admin_chat_reads (
  id BIGINT PRIMARY KEY,
  admin_id BIGINT NOT NULL,           -- 管理者ID
  chat_room_id BIGINT NOT NULL,       -- チャットルームID
  last_read_at TIMESTAMP NULL,        -- 最後の既読時刻
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(admin_id, chat_room_id)
);
```

### 2. モデルの実装 (`backend/app/Models/AdminChatRead.php`)

#### 主要メソッド
- `updateLastRead($adminId, $chatRoomId)`: 既読時刻を更新
- `getUnreadCount($adminId, $chatRoomId)`: 特定チャットの未読数取得
- `getUnreadCountsForChatRooms($adminId, $chatRoomIds)`: 複数チャットの未読数一括取得
- `getTotalUnreadCount($adminId)`: 管理者の総未読数取得
- `getChatRoomsWithUnreadMessages($adminId)`: 未読メッセージがあるチャットID取得

### 3. コントローラの修正 (`backend/app/Http/Controllers/Admin/AdminDashboardController.php`)

#### `supportConversations` メソッドの更新
- **真の未読フィルタ**: 管理者の実際の既読状態に基づくフィルタリング
- **効率的な未読数計算**: 一括取得による性能最適化

#### フィルタ条件
```php
// 真の既読状態ベースフィルタ
if ($request->get('filter') === 'unread') {
  $unreadChatRoomIds = \App\Models\AdminChatRead::getChatRoomsWithUnreadMessages($admin->id);
  if (!empty($unreadChatRoomIds)) {
    $query->whereIn('id', $unreadChatRoomIds);
  } else {
    $query->whereRaw('1 = 0'); // 未読なしの場合は空結果
  }
}
```

#### 既読処理の復活
- **手動既読**: 管理者が明示的に「既読にする」ボタンを押した時のみ既読
- **返信時自動既読**: 管理者が返信した時は自動的に既読記録
- **AJAX既読**: 非同期での既読更新
- **視覚的フィードバック**: 未読メッセージのハイライト表示

### 4. ビューの修正

#### サポート一覧ページ (`backend/resources/views/admin/support/index.blade.php`)
1. **フィルタ選択ドロップダウン**: 検索フォームにフィルタオプションを追加
   - 「すべてのチャット」
   - 「未読メッセージのあるチャットのみ」

2. **クイックフィルタボタン**: ページ上部に未読のみ表示/すべて表示の切り替えボタン

3. **視覚的インジケータ**:
   - 未読メッセージがあるチャット行をハイライト表示（`table-warning` クラス）
   - 未読メッセージ数を「○件の未読」として表示
   - ヘッダーに総未読メッセージ数を表示

4. **フィルタ状態の表示**: 
   - フィルタ適用時にヘッダーに「未読メッセージのみ表示」バッジを表示
   - 空の状態でもフィルタに応じたメッセージを表示

#### サポート詳細ページ (`backend/resources/views/admin/support/detail.blade.php`)
1. **動的既読ボタン**: 未読数に応じてボタン表示を変更
   - 未読あり: 「○件の未読を既読にする」（黄色ボタン）
   - 既読済み: 「既読済み」（緑色・無効化）
2. **未読メッセージハイライト**: 未読のユーザーメッセージを視覚的に強調
3. **AJAX既読処理**: 非同期で既読状態を更新
4. **ローディング状態**: 既読処理中の視覚的フィードバック
5. **レイアウト**: 既読ボタンを返信フォームの送信ボタン左横に配置

## 使用方法

### 1. 新着メッセージのフィルタリング
- ページ上部の「新着のみ表示」ボタンをクリック
- または検索フォームのフィルタドロップダウンから「新着メッセージのあるチャットのみ」を選択

### 2. すべてのチャットの表示
- 「すべて表示」ボタンをクリック
- または「クリア」ボタンでフィルタをリセット

## 技術的詳細

### 新着メッセージの定義
- **対象**: ユーザーからのメッセージ（`sender_id` が null でない）
- **期間**: 過去7日以内（`sent_at >= now()->subDays(7)`）
- **除外**: 削除されたメッセージ（`deleted_at` または `admin_deleted_at` が null でない）

### 管理者読み取り状況について
**✅ 完全復活**: 管理者の読み取り状況を追跡する `admin_chat_reads` テーブルを新規作成し、真の既読システムを復活させました。

#### 既読判定ロジック
1. **初回アクセス**: 既読記録がない場合、すべてのユーザーメッセージが未読
2. **既読記録あり**: `last_read_at` より後のメッセージが未読
3. **手動既読**: 管理者が明示的に「既読にする」ボタンを押した時のみ既読
4. **返信時既読**: 管理者が返信した時は自動的に既読更新
5. **視覚的区別**: 未読メッセージは黄色でハイライト（アニメーションなし）

### パフォーマンス考慮
- フィルタリングはデータベースレベルで実行され、効率的な検索を実現
- ページネーションと組み合わせて大量のデータにも対応

## URL例
- すべてのチャット: `http://localhost/admin/support`
- 新着メッセージのみ: `http://localhost/admin/support?filter=unread`
- 検索と組み合わせ: `http://localhost/admin/support?search=ユーザー名&filter=unread`

## 実装された機能まとめ

### ✅ 完了済み
1. **管理者既読システムの完全復活**
2. **真の未読状態に基づくフィルタリング**
3. **自動既読機能（詳細表示・返信時）**
4. **手動既読機能（既読ボタン）**
5. **AJAX既読更新**
6. **効率的な未読数計算**
7. **視覚的インジケータ（未読チャットのハイライト）**

### 🔄 今後の改善案
1. **リアルタイム更新機能**（WebSocket/Server-Sent Events）
2. **プッシュ通知機能**
3. **既読状態の履歴管理**
4. **複数管理者間の既読状態共有**
5. **未読メッセージの優先度設定**